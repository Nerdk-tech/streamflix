<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix - Your Home for Streaming</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .main-header {
            background-color: #222;
            padding: 20px;
            border-bottom: 2px solid red;
        }
        .main-container {
            padding: 20px;
        }
        /* Search Bar */
        .search-bar-section {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        #search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: #f0f0f0;
        }
        button {
            padding: 10px 20px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: darkred;
        }
        /* Content Grids */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .movie-card {
            background-color: #222;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .movie-card:hover {
            transform: scale(1.05);
        }
        .movie-card img {
            width: 100%;
            height: auto;
            display: block;
        }
        .movie-info {
            padding: 10px;
        }
        .movie-title {
            font-size: 0.9em;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .movie-rating {
            font-size: 0.8em;
            color: gold;
        }
        .message {
            padding: 20px;
            text-align: center;
            font-size: 1.1em;
            color: #aaa;
        }

        /* Detail Page Styling */
        #detail-page {
            margin-top: 30px;
        }
        .detail-header {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .detail-poster {
            width: 300px;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .detail-info {
            flex-grow: 1;
        }
        .detail-info h1 {
            margin-top: 0;
            color: white;
        }
        .detail-meta {
            font-size: 0.9em;
            color: #ccc;
        }
        .detail-plot {
            margin: 20px 0;
            line-height: 1.6;
        }
        .detail-cast-list span {
            display: block;
            font-size: 0.9em;
            color: #aaa;
        }
        .detail-play-button {
            margin-top: 20px;
            font-size: 1.1em;
            padding: 12px 25px;
        }

        /* Video Player Styling */
        #video-player-section {
            margin-top: 30px;
            background-color: #000;
            padding: 20px;
            border-radius: 8px;
        }
        #player-container {
            width: 100%;
            height: 500px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .detail-header {
                flex-direction: column;
                align-items: center;
            }
            .detail-poster {
                width: 100%;
                max-width: 300px;
                margin-bottom: 20px;
            }
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1>StreamFlix</h1>
        <p>Your Home for Streaming | Preview</p>
    </header>

    <div class="main-container">
        <div class="search-bar-section">
            <input type="text" id="search-input" placeholder="Search for movies or series...">
            <button onclick="fetchSearchResults()">Search</button>
        </div>
        
        <section id="detail-page" style="display: none;">
            <p class="message">Loading movie details...</p>
        </section>

        <section id="video-player-section" style="display: none;">
            <h2 id="video-title">Now Playing: </h2>
            <p id="player-message">Please wait while we secure the stream link.</p>
            <div id="player-container">
                </div>
            <button onclick="clearSearch()" class="go-back-button" style="margin-top: 20px;">
                <i class="fa-solid fa-arrow-left"></i> Back to Home
            </button>
        </section>

        <section id="search-results-section" style="display: none;">
            <h2 id="search-results-title">Search Results for <span></span></h2>
            <div id="search-content" class="content-grid">
                </div>
        </section>

        <section id="hot-movies-section">
            <h2>ðŸ”¥ Hot Movies</h2>
            <div id="movie-content" class="content-grid">
                <p class="message">Loading hot movies...</p>
            </div>
        </section>

        <section id="hot-series-section">
            <h2>âš¡ Trending Series</h2>
            <div id="series-content" class="content-grid">
                <p class="message">Loading trending series...</p>
            </div>
        </section>
    </div>

    <script>
        // --- API CONFIGURATION ---
        const API_KEY = "Godszeal"; 
        const BASE_URL = "https://gzmovieboxapi.vercel.app/api/";

        // API ENDPOINT URLs
        const HOT_CONTENT_URL = `${BASE_URL}hot-movies-series?apikey=${API_KEY}`;
        const SEARCH_URL = `${BASE_URL}search?apikey=${API_KEY}`;
        const MEDIA_URL = `${BASE_URL}media?apikey=${API_KEY}`;
        const DETAIL_URL = `${BASE_URL}item-details?apikey=${API_KEY}`;

        // ====================================================================
        // CORE UTILITY FUNCTIONS (Defined first)
        // ====================================================================

        function toggleContentSections(isSearching, isDetail) {
            const isHome = !isSearching && !isDetail;
            document.getElementById('detail-page').style.display = isDetail ? 'block' : 'none';
            document.getElementById('search-results-section').style.display = isSearching ? 'block' : 'none';
            document.getElementById('hot-movies-section').style.display = isHome ? 'block' : 'none';
            document.getElementById('hot-series-section').style.display = isHome ? 'block' : 'none';
            document.getElementById('video-player-section').style.display = 'none';
        }

        function clearSearch() {
            document.getElementById('search-input').value = "";
            toggleContentSections(false, false);
            document.querySelector('.main-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // ====================================================================
        // API 4: Fetch and Display the Stream (Must be defined before it's called)
        // ====================================================================
        async function fetchAndDisplayStream(subjectId, detailPath, title) {
            const playerSection = document.getElementById('video-player-section');
            const playerContainer = document.getElementById('player-container');
            const playerMessage = document.getElementById('player-message');
            const videoTitle = document.getElementById('video-title');

            playerContainer.innerHTML = '<p class="message">Fetching stream link...</p>';
            videoTitle.textContent = `Now Playing: ${title}`;
            playerSection.style.display = 'block';
            playerMessage.textContent = 'Please wait while we secure the stream link.';

            playerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const streamUrl = `${MEDIA_URL}&subjectId=${subjectId}&detailPath=${detailPath}`;

            try {
                const response = await fetch(streamUrl);
                const data = await response.json();

                // FIXED: Robust check for required data structure
                if (data && data.data && data.data.resource) {
                    const resource = data.data.resource;
                    const videoLink = resource.hls || resource.mp4;
                    const finalTitle = title || 'Media Content';

                    if (videoLink) {
                        playerMessage.textContent = 'Stream found! Playing video.';
                        videoTitle.textContent = `Now Playing: ${finalTitle}`;
                        playerContainer.innerHTML = `
                            <video id="streamflix-player" controls preload="auto" style="width: 100%; height: 500px; background-color: black;">
                                <source src="${videoLink}" type="${resource.hls ? 'application/x-mpegURL' : 'video/mp4'}">
                                Your browser does not support the video tag.
                            </video>
                        `;

                        const videoElement = document.getElementById('streamflix-player');
                        videoElement.play().catch(e => {
                            console.error("Video Playback Error (Autoplay/CORS):", e);
                            playerMessage.textContent = 'Error: Video failed to auto-play (Browser restriction). Please tap the play button manually.';
                        });
                        
                    } else {
                        playerMessage.textContent = 'Error: No direct stream link (HLS or MP4) was found in the API response data.';
                        playerContainer.innerHTML = '<p class="message">Resource not available. Try another title or check back later.</p>';
                    }

                } else if (data && data.status === 'error') {
                     playerMessage.textContent = `API Error: ${data.message || 'The API returned an error status.'}`;
                     playerContainer.innerHTML = '<p class="message">Could not load the streaming resource due to an API error.</p>';
                
                } else {
                    console.error("Unexpected API response structure:", data); 
                    playerMessage.textContent = `General Fetch Error: Unknown response structure.`;
                    playerContainer.innerHTML = '<p class="message">An unexpected error occurred during the media fetch.</p>';
                }
            } catch (error) {
                console.error("Critical network error during stream fetch:", error);
                playerMessage.textContent = 'A critical network error occurred. Check your internet connection or console for details.';
                playerContainer.innerHTML = '<p class="message">Network request failed.</p>';
            }
        }

        // ====================================================================
        // API 3: Fetch and Display Detail Page (Must be defined before it's called)
        // ====================================================================
        async function showDetailPage(subjectId, detailPath, title, posterUrl) {
            const detailPage = document.getElementById('detail-page');
            toggleContentSections(false, true);
            detailPage.innerHTML = '<p class="message">Loading movie details...</p>';
            detailPage.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const detailUrl = `${DETAIL_URL}&subjectId=${subjectId}&detailPath=${detailPath}`;

            try {
                const response = await fetch(detailUrl);
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    const item = data.data;
                    
                    const castHtml = item.staffList 
                        ? item.staffList.map(staff => `<span>${staff.name} (${staff.role})</span>`).join('')
                        : 'No cast information available.';

                    detailPage.innerHTML = `
                        <div class="detail-header">
                            <img src="${posterUrl}" alt="${item.title || title}" class="detail-poster">
                            <div class="detail-info">
                                <h1>${item.title || title || 'Title Unavailable'}</h1>
                                <p class="detail-meta">
                                    <i class="fa-solid fa-star" style="color: gold;"></i> ${item.imdbRatingValue || 'N/A'} 
                                    | ${item.releaseDate ? item.releaseDate.substring(0, 4) : 'N/A'}
                                    | ${item.genre ? item.genre.split(',').join(' / ') : 'N/A'}
                                    | ${item.countryName || 'N/A'}
                                </p>
                                <p class="detail-plot">${item.description || 'No plot summary available.'}</p>
                                
                                <h3>Cast & Crew</h3>
                                <div class="detail-cast-list">${castHtml}</div>
                                
                                <button class="detail-play-button" onclick="fetchAndDisplayStream('${subjectId}', '${detailPath}', '${item.title || title}')">
                                    <i class="fa-solid fa-play"></i> Play Now
                                </button>
                                <button onclick="clearSearch()" class="go-back-button" style="margin-left: 20px;">
                                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                                </button>
                            </div>
                        </div>
                    `;
                    
                } else {
                    detailPage.innerHTML = '<p class="message">Failed to load detailed information for this title.</p>';
                }

            } catch (error) {
                console.error("Error fetching detail page:", error);
                detailPage.innerHTML = '<p class="message">A network error occurred while fetching details.</p>';
            }
        }


        // ====================================================================
        // Utility to create HTML cards (Uses showDetailPage)
        // ====================================================================
        function createCard(item, containerId) {
            const container = document.getElementById(containerId);
            const card = document.createElement('div');
            card.className = 'movie-card';
            
            // Clicking the card opens the Detail Page
            card.onclick = () => showDetailPage(item.subjectId, item.detailPath, item.title, item.cover.url);

            const img = document.createElement('img');
            img.src = item.cover.url;
            img.alt = item.title;

            const info = document.createElement('div');
            info.className = 'movie-info';

            const title = document.createElement('p');
            title.className = 'movie-title';
            title.textContent = item.title;

            const rating = document.createElement('p');
            rating.className = 'movie-rating';
            const ratingValue = item.imdbRatingValue && item.imdbRatingValue !== "0.0" ? item.imdbRatingValue : "N/A";
            rating.innerHTML = `<i class="fa-solid fa-star"></i> ${ratingValue}`;

            info.appendChild(title);
            info.appendChild(rating);
            card.appendChild(img);
            card.appendChild(info);
            container.appendChild(card);
        }


        // ====================================================================
        // API 1 & 2 (Depend on createCard)
        // ====================================================================
        async function fetchHotContent() {
            toggleContentSections(false, false); 
            
            const movieContent = document.getElementById('movie-content');
            const seriesContent = document.getElementById('series-content');

            movieContent.innerHTML = '<p class="message">Loading hot movies...</p>';
            seriesContent.innerHTML = '<p class="message">Loading trending series...</p>';

            try {
                const response = await fetch(HOT_CONTENT_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                movieContent.innerHTML = '';
                seriesContent.innerHTML = '';

                if (data.data && data.data.movie && data.data.movie.length > 0) {
                    data.data.movie.forEach(item => createCard(item, 'movie-content'));
                } else {
                    movieContent.innerHTML = '<p class="message">No hot movies found in the API data.</p>';
                }

                if (data.data && data.data.tv && data.data.tv.length > 0) {
                    data.data.tv.forEach(item => createCard(item, 'series-content'));
                } else {
                    seriesContent.innerHTML = '<p class="message">No trending series found in the API data.</p>';
                }

            } catch (error) {
                console.error("Critical error fetching hot content:", error);
                const errorMessage = `Failed to load content. Error: ${error.message}. This is likely a network or temporary API issue.`;
                
                movieContent.innerHTML = `<p class="message" style="color: yellow;">${errorMessage}</p>`;
                seriesContent.innerHTML = `<p class="message" style="color: yellow;">Please check your connection and try the Search bar.</p>`;
            }
        }

        async function fetchSearchResults() {
            const searchInput = document.getElementById('search-input');
            const keyword = searchInput.value.trim();
            const searchContent = document.getElementById('search-content');
            const searchTitle = document.getElementById('search-results-title').querySelector('span');
            
            if (keyword.length < 2) {
                clearSearch(); 
                return;
            }

            toggleContentSections(true, false);
            searchTitle.textContent = `Search Results for "${keyword}"`;
            searchContent.innerHTML = '<p class="message">Searching...</p>';

            const encodedKeyword = encodeURIComponent(keyword);
            const searchUrl = `${SEARCH_URL}&keyword=${encodedKeyword}`;
            
            try {
                const response = await fetch(searchUrl);
                const data = await response.json();

                searchContent.innerHTML = '';

                if (data.data && data.data.items && data.data.items.length > 0) {
                    data.data.items.forEach(item => createCard(item, 'search-content'));
                    document.ge